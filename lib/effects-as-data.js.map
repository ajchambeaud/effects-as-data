{"version":3,"sources":["../src/effects-as-data.js"],"names":[],"mappings":"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","file":"effects-as-data.js","sourcesContent":["const { map, keys, curry, merge, flatten, reduce, toPairs } = require('ramda')\nconst { toArray, toPromise, keyed } = require('./util')\nconst { stateReducer } = require('./state-reducer')\nconst { addToContext, addToErrors } = require('./actions')\n\nconst runPipe = curry((plugins, pipeRaw, state, index = 0) => {\n  let wrappedPlugins = wrapPlugins(plugins)\n  return runPipeRecursive(wrappedPlugins, pipeRaw, state, index)\n})\n\nconst runPipeRecursive = (plugins, pipeRaw, state, index = 0) => {\n  let state1 = normalizeState(state)\n  let pipe = normalizePipe(pipeRaw)\n\n  if (isEndOfPipe(pipe, index)) {\n    return Promise.resolve(state1)\n  }\n\n  let fn = pipeFn(pipe, index)\n  let result = fn(state1)\n  let results = toArray(result)\n\n  return runActions(merge(defaultPlugins, plugins), results).then((actions) => {\n    let state2 = stateReducer(state1, actions)\n    let shouldEnd = actions.some((a) => a.type === 'end')\n    return shouldEnd ? state2 : runPipeRecursive(plugins, pipe, state2, index + 1)\n  })\n}\n\nfunction wrapPlugins (plugins) {\n  return reduce((p, name) => {\n    p[name] = (allPlugins, action) => {\n      let result = plugins[name](action.payload)\n      return resultToStateAction(action, result)\n    }\n    return p\n  }, {}, keys(plugins))\n}\n\nfunction runActions (plugins, actions) {\n  // let promises = map(routeActionToHandler(plugins), actions)\n  let promises = map((action) => {\n    return plugins[action.type](plugins, action)\n  }, actions)\n  return Promise.all(promises)\n}\n\n// const routeActionToHandler = curry((plugins, action) => {\n//   let handler = defaultPlugins[action.type] || runAction\n//   return handler(plugins, action)\n// })\n\nconst runAction = curry((plugins, action) => {\n  let plugin = plugins[action.type]\n\n  if (typeof plugin === 'undefined') {\n    throw new Error(`\"${action.type}\" is not a registered plugin.`)\n  }\n\n  let pluginResult = plugin(action.payload)\n  return resultToStateAction(action, pluginResult)\n})\n\nconst stateActionHandler = (plugins, action) => {\n  return action\n}\n\nconst callActionHandler = (plugins, action) => {\n  return runPipeRecursive(plugins, action.pipe, action.state).then((state) => {\n    return addToContext(keyed(action.contextKey, state))\n  })\n}\n\nconst mapPipeActionHandler = (plugins, action) => {\n  let mapResults = map((s) => {\n    return runPipeRecursive(plugins, action.pipe, s)\n  }, action.state)\n\n  return Promise.all(mapResults).then((results) => {\n    return addToContext(keyed(action.contextKey, results))\n  })\n}\n\nconst panicActionHandler = (plugins, action) => {\n  return Promise.reject(action.error)\n}\n\nconst defaultPlugins = {\n  setPayload: stateActionHandler,\n  addToErrors: stateActionHandler,\n  addToContext: stateActionHandler,\n  end: stateActionHandler,\n  call: callActionHandler,\n  mapPipe: mapPipeActionHandler,\n  panic: panicActionHandler\n}\n\nfunction resultToStateAction (action, pluginResult) {\n  return toPromise(pluginResult)\n  .then((payload) => {\n    return addToContext(keyed(action.contextKey, payload))\n  })\n  .catch((error) => {\n    return addToErrors(keyed(action.contextKey, error))\n  })\n}\n\nfunction isEndOfPipe (pipe, i) {\n  return i >= pipe.length\n}\n\nfunction pipeFn (pipe, i) {\n  return pipe[i]\n}\n\nfunction normalizeState (state) {\n  if (!state) {\n    return emptyState()\n  }\n\n  if (state.context && state.errors && state.payload) {\n    return state\n  }\n\n  return merge(emptyState(), {\n    payload: state\n  })\n}\n\nfunction normalizePipe (pipe) {\n  let pipeAsArray = toArray(pipe)\n  return flatten(pipeAsArray)\n}\n\nconst emptyState = () => {\n  return {\n    context: {},\n    payload: {},\n    errors: {}\n  }\n}\n\nconst buildPipes = (plugins, pipes) => {\n  let pairs = toPairs(pipes)\n  return reduce((p, [key, pipe]) => {\n    p[key] = (state = {}) => {\n      return runPipe(plugins, pipe, state)\n    }\n    return p\n  }, {}, pairs)\n}\n\nmodule.exports = {\n  runAction,\n  emptyState,\n  runPipe,\n  normalizePipe,\n  normalizeState,\n  buildPipes\n}\n"]}